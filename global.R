make_geojson <- function(lon, lat) {
  gj <- glue::glue(
    '
{
  "type": "FeatureCollection",
  "features": [{
    "type": "Feature",
    "geometry" : {
      "type": "Point",
      "coordinates": [${lon}$, ${lat}$]
    }
  }]
}
      ',
    .open = "${",
    .close = "}$"
  )
}

extract_coords_from_string <- function(s) {
  stringr::str_extract_all(s, "[-+]?[0-9]+\\.?[0-9]*")[[1]] %>% 
    as.numeric() %>% 
    na.omit()
}

reproject_coords <- function(x, crs_from, crs_to) {
  st_point(x) %>%
    st_sfc(crs = crs_from) %>%
    st_transform(crs_to) %>%
    st_coordinates()
}

x_breaks <- function(x) {
  brk <- scales::breaks_extended(n = 7)(x)

  if (isTRUE(diff(brk)[1] > 200)) {
    brk <- seq(0, max(brk) + 200, by = 200)
  }
  
  brk
}

y_labels <- function(brk) {
  lbl <- scales::label_number()(brk)

  if (isTRUE(nchar(na.omit(lbl)[1]) < 4)) {
    lbl <- scales::label_number(0.01)(brk)
  }
  
  lbl
}

put_ll_in_order <- function(x, ref_ll, poss_crs) {
  candidates <- list(x, rev(x))
  
  if (any(abs(x) > 180)) {
    candidates <- 
      purrr::map(
        candidates,
        ~reproject_coords(.x, poss_crs, 4326)
      ) %>% 
      purrr::keep(
        ~all(is.finite(.x))
        )
  }
  
  d <- purrr::map_dbl(
    candidates, 
    ~dist(rbind(.x, ref_ll))
    )
  
  candidates[[which.min(d)]]
}


wavelengths <- 
  c(402.4401855, 411.3163757, 419.3724976, 426.9674377, 434.3084106, 441.658905, 449.0336304, 456.3773499,
    463.7309875, 470.9488831, 478.1763, 485.4096069, 492.6999207, 500.1372375, 507.663147, 515.1757813, 522.9161987, 530.6670532,
    538.4870605, 546.4799805, 554.5645752, 562.7365723, 571.0028076, 579.3516846, 587.8235474, 596.4750977, 605.3911743, 614.1723022,
    623.1970825, 632.1316528, 641.333252, 650.7905273, 660.2636108, 669.8167114, 679.4727783, 689.4208374, 699.0958862, 708.9966431,
    719.1722412, 729.2445068, 739.4175415, 749.7307129, 760.0969238, 770.5285034, 780.9124146, 791.3615723, 801.9365845, 812.539856,
    823.145813, 833.7513428, 844.427124, 855.1821289, 865.9494019, 876.6408081, 887.2658691, 897.9865112, 908.6439819, 919.1762695,
    929.385498, 939.8600464, 951.3615112, 962.2644653, 972.6346436, 942.9578857, 951.0114136, 959.5220337, 969.3899536, 978.7376709,
    988.4115601, 998.374939, 1008.168274, 1017.984619, 1028.806274, 1037.764648, 1047.431152, 1057.380371, 1067.609985, 1078.039063,
    1088.589844, 1099.108276, 1109.740845, 1120.494629, 1131.143066, 1141.873657, 1152.471558, 1163.484131, 1174.525757, 1185.397949,
    1196.174805, 1207.114868, 1217.695923, 1228.998901, 1240.056763, 1250.795532, 1262.334351, 1273.306396, 1284.279541, 1295.196655,
    1306.047241, 1317.0177, 1328.089722, 1338.946289, 1349.598999, 1360.842651, 1372.718994, 1383.008301, 1394.524658, 1405.388306,
    1416.310303, 1427.105591, 1438.169922, 1448.920898, 1459.067505, 1469.700317, 1480.620117, 1491.197754, 1501.779297, 1512.413696,
    1523.00708, 1533.564453, 1544.030151, 1554.580078, 1565.12146, 1575.393066, 1585.63147, 1595.979492, 1606.243286, 1616.583984,
    1626.78125, 1636.854614, 1646.972778, 1656.772339, 1666.966553, 1677.124634, 1687.171753, 1697.009277, 1706.807495, 1716.597534,
    1726.4375, 1736.255615, 1745.929443, 1755.54895, 1765.253174, 1774.909302, 1784.441895, 1793.689087, 1803.365967, 1812.820557,
    1822.148804, 1831.741211, 1841.049438, 1850.278687, 1859.297607, 1868.018066, 1878.463257, 1886.810913, 1895.846436, 1904.628174,
    1914.047852, 1923.089111, 1931.991577, 1940.830566, 1949.639038, 1958.370605, 1967.05896, 1975.781372, 1984.547852, 1993.288574,
    2001.842773, 2010.410278, 2019.049561, 2027.475952, 2035.995239, 2044.422363, 2052.757324, 2061.137939, 2069.538818, 2077.751709,
    2086.10083, 2094.407715, 2102.548096, 2110.81665, 2118.955322, 2127.093994, 2135.235352, 2143.22583, 2151.125732, 2159.287842,
    2167.252441, 2175.071289, 2183.18335, 2190.835449, 2198.886963, 2206.597656, 2214.341553, 2222.192871, 2229.753174, 2237.647705,
    2245.213623, 2252.848389, 2260.62793, 2268.042236, 2275.769531, 2283.275146, 2290.572998, 2298.334961, 2305.502197, 2312.912109,
    2320.640137, 2327.606934, 2335.236084, 2342.588867, 2349.575195, 2357.022461, 2364.37085, 2371.336426, 2378.509521, 2385.808594,
    2392.841797, 2399.801025, 2407.338623, 2414.156494, 2420.987305, 2428.400146, 2435.326904, 2442.187744, 2448.923584, 2456.32959,
    2462.812988, 2469.415527, 2476.79126, 2483.590576, 2490.028076, 2496.874023)

wv_src <- cumsum(wavelengths < lag(wavelengths, default = F))

